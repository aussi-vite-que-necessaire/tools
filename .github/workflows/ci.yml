name: CI & Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install system dependencies for Puppeteer
        timeout-minutes: 10
        run: |
          sudo apt-get update -qq
          # Install chromium and dependencies
          # Note: chromium-sandbox is included in chromium package on Ubuntu 24.04+
          # Use DEBIAN_FRONTEND=noninteractive to avoid prompts
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y \
            chromium \
            fonts-liberation \
            libappindicator3-1 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgdk-pixbuf2.0-0 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            xdg-utils
          # Try to install libasound2t64 (Ubuntu 24.04+), fallback to libasound2
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y libasound2t64 2>/dev/null || \
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y libasound2 || true

      - name: Set Puppeteer environment variables
        run: |
          echo "PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true" >> $GITHUB_ENV
          # Try chromium first, fallback to chromium-browser
          if [ -f /usr/bin/chromium ]; then
            echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium" >> $GITHUB_ENV
          elif [ -f /usr/bin/chromium-browser ]; then
            echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser" >> $GITHUB_ENV
          else
            echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run unit tests
        run: npm run test:unit

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Build project
        run: npm run build

  # --- JOB 2 : BUILD & PUSH DOCKER IMAGE (seulement sur push vers main) ---
  build-and-push:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lowercase Repo Name
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{ env.REPO_LOWER }}/tools-api:latest
          cache-from: type=gha,scope=tools-api
          cache-to: type=gha,mode=max,scope=tools-api

  # --- JOB 3 : D√âPLOIEMENT SUR VPS (seulement sur push vers main) ---
  deploy:
    needs: [test, build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lowercase Repo Name
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      # --- NETTOYAGE ---
      - name: Force Clean Remote Directory
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p apps/${{ vars.PROJECT_NAME }}
            cd apps/${{ vars.PROJECT_NAME }}
            rm -rf docker-compose.yml .env || true

      # --- ENVOI DU DOCKER-COMPOSE ---
      - name: Copy docker-compose.yml to VPS
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml"
          target: "apps/${{ vars.PROJECT_NAME }}"

      # --- D√âPLOIEMENT ---
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1
        env:
          REPO_LOWER: ${{ env.REPO_LOWER }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: REPO_LOWER
          script: |
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker image prune -f

            cd ~/apps/${{ vars.PROJECT_NAME }}

            # --- A. G√âN√âRATION DU .ENV ---
            echo "üîß G√©n√©ration .env..."
            REPO_LOWER="$REPO_LOWER"
            # Use API_URL if set, otherwise construct from MAIN_DOMAIN
            if [ -n "${{ vars.API_URL }}" ]; then
              DOMAIN_NAME="${{ vars.API_URL }}"
            else
              DOMAIN_NAME="https://api.${{ vars.MAIN_DOMAIN }}"
            fi
            # Remove https:// if present for Traefik Host rule
            DOMAIN_NAME_CLEAN=$(echo "$DOMAIN_NAME" | sed 's|https\?://||')
            cat <<EOF > .env
            IMAGE_NAME=ghcr.io/$REPO_LOWER/tools-api:latest
            PROJECT_NAME=${{ vars.PROJECT_NAME }}
            NODE_ENV=production
            PORT=3000
            API_URL=$DOMAIN_NAME
            DOMAIN_NAME=$DOMAIN_NAME_CLEAN
            PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
            PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
            EOF
            chmod 600 .env

            # --- B. PULL & START ---
            echo "üì• Pull & Start..."
            docker compose pull
            docker compose up -d --remove-orphans

            # --- C. HEALTH CHECK ---
            echo "üè• V√©rification de la sant√© du service..."
            sleep 10
            MAX_WAIT=60
            WAITED=0
            SERVICE_NAME="tools-api"
            while [ $WAITED -lt $MAX_WAIT ]; do
              if docker compose exec -T $SERVICE_NAME node -e "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" 2>/dev/null; then
                echo "‚úÖ Service healthy !"
                break
              fi
              echo "‚è≥ Attente... ($WAITED/$MAX_WAIT secondes)"
              sleep 5
              WAITED=$((WAITED + 5))
            done

            if [ $WAITED -ge $MAX_WAIT ]; then
              echo "‚ö†Ô∏è Service health check timeout, mais le d√©ploiement continue"
              docker compose logs --tail=50 $SERVICE_NAME
            fi

            echo "‚úÖ D√©ploiement termin√© !"
